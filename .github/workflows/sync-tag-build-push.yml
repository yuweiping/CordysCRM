name: Sync Tag + Build + PushPlus Notify

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      dockerImageTag:
        default: 'latest'
        required: true
      architecture:
        default: 'linux/amd64'
        required: true
        type: choice
        options: [linux/amd64, linux/arm64, linux/amd64,linux/arm64]

permissions:
  contents: write
  packages: write

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    outputs:
      has_new_tag: ${{ steps.check-tag.outputs.has_new_tag }}
      latest_tag: ${{ steps.check-tag.outputs.latest_tag }}
      release_notes: ${{ steps.get-notes.outputs.release_notes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev-yu
          fetch-tags: true

      - name: 拉取上游+本地仓库最新tag（关键修复）
        env:
          UPSTREAM_REPO: "https://github.com/1Panel-dev/CordysCRM.git"
        run: |
          # 1. 添加上游仓库
          git remote add upstream $UPSTREAM_REPO 2>/dev/null || true
          # 2. 拉取原仓库所有tag
          git fetch upstream --tags --prune
          # 3. 拉取fork仓库（origin）最新tag（核心：获取删除后的远程状态）
          git fetch origin --tags --prune

      - name: 核心判断：是否有新tag（对比原仓库vs fork远程tag）
        id: check-tag
        run: |
          # 1. 原仓库最新tag（清理字符）
          UPSTREAM_TAG=$(git ls-remote --tags upstream | grep -v '{}' | awk '{print $2}' | sed 's/refs\/tags\///' | sort -V | tail -n 1 | xargs)
          # 2. fork远程仓库最新tag（关键：不再读本地，读远程origin）
          FORK_REMOTE_TAG=$(git ls-remote --tags origin | grep -v '{}' | awk '{print $2}' | sed 's/refs\/tags\///' | sort -V | tail -n 1 | xargs)
          
          # 输出关键对比值（方便排查）
          echo "原仓库tag: $UPSTREAM_TAG"
          echo "Fork远程tag: $FORK_REMOTE_TAG"
          
          # 3. 判断逻辑：原tag非空 + 与fork远程tag不一致 → 有新tag
          if [[ -n "$UPSTREAM_TAG" && "$UPSTREAM_TAG" != "$FORK_REMOTE_TAG" ]]; then
            echo "has_new_tag=true" >> $GITHUB_OUTPUT
            echo "latest_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          else
            echo "has_new_tag=false" >> $GITHUB_OUTPUT
            echo "latest_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          fi

      - name: 获取Release说明
        id: get-notes
        if: steps.check-tag.outputs.has_new_tag == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=${{ steps.check-tag.outputs.latest_tag }}
          NOTES=$(gh api repos/1Panel-dev/CordysCRM/releases/tags/$TAG --jq '.body' 2>/dev/null || echo "无发布说明")
          NOTES=$(echo "$NOTES" | sed 's/\n/<br>/g')
          echo "release_notes=$NOTES" >> $GITHUB_OUTPUT

      - name: 同步tag到fork仓库 + 合并dev-yu
        if: steps.check-tag.outputs.has_new_tag == 'true'
        run: |
          TAG=${{ steps.check-tag.outputs.latest_tag }}
          # 推送tag到fork远程
          git push origin $TAG
          # 合并到dev-yu分支
          git checkout dev-yu
          git merge --no-edit --strategy-option theirs $TAG
          git push origin dev-yu

      - name: PushPlus推送
        if: steps.check-tag.outputs.has_new_tag == 'true'
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        run: |
          TAG=${{ steps.check-tag.outputs.latest_tag }}
          NOTES=${{ steps.get-notes.outputs.release_notes }}
          curl -X POST https://www.pushplus.plus/send \
            -H "Content-Type: application/json" \
            -d "{
              \"token\":\"$PUSHPLUS_TOKEN\",
              \"title\":\"CordysCRM 新Tag: $TAG\",
              \"content\":\"新版本：$TAG<br>发布说明：$NOTES\",
              \"template\":\"html\"
            }"

  # 打包推送：和推送完全联动
  build-docker:
    needs: sync-tag
    if: needs.sync-tag.outputs.has_new_tag == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev-yu
          fetch-depth: 0

      - name: 准备镜像标签
        id: prepare
        run: |
          TAG=${{ needs.sync-tag.outputs.latest_tag || github.event.inputs.dockerImageTag }}
          echo "build_args=--tag ${{ secrets.DOCKERHUB_USERNAME }}/cordys-crm-ce:$TAG --tag ${{ secrets.DOCKERHUB_USERNAME }}/cordys-crm-ce:latest" >> $GITHUB_OUTPUT

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: 登录DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 构建并推送
        run: |
          docker buildx build --platform ${{ github.event.inputs.architecture }} \
            --output "type=image,push=true" \
            ${{ steps.prepare.outputs.build_args }} \
            -f installer/Dockerfile .
