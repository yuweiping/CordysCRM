name: Sync Tag + Build & Push to DockerHub + PushPlus Notify

on:
  schedule:
    - cron: '0 18 * * *'  # 每天凌晨2点（UTC+8）
  workflow_dispatch:
    inputs:
      dockerImageTag:
        description: 'Docker镜像标签'
        default: 'latest'
        required: true
      architecture:
        description: '架构'
        default: 'linux/amd64'
        required: true
        type: choice
        options:
          - linux/amd64
          - linux/arm64
          - linux/amd64,linux/arm64

permissions:
  contents: write
  packages: write
  repository-projects: read

jobs:
  sync-tag-merge:
    runs-on: ubuntu-latest
    outputs:
      latest_tag: ${{ steps.get-latest-tag.outputs.latest_upstream_tag }}
      has_new_tag: ${{ steps.check-new-tag.outputs.has_new_tag }}
      release_notes: ${{ steps.get-release-notes.outputs.release_notes }}
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev-yu

      - name: 配置Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: 添加上游仓库
        env:
          UPSTREAM_REPO: "https://github.com/1Panel-dev/CordysCRM.git"
        run: |
          git remote add upstream $UPSTREAM_REPO 2>/dev/null || true
          git fetch upstream --tags --prune
          git fetch origin

      - name: 获取最新tag
        id: get-latest-tag
        run: |
          LATEST_UPSTREAM_TAG=$(git ls-remote --tags upstream | grep -v '{}' | awk '{print $2}' | sed 's/refs\/tags\///' | sort -V | tail -n 1)
          LATEST_FORK_TAG=$(git tag -l | sort -V | tail -n 1)
          echo "latest_upstream_tag=$LATEST_UPSTREAM_TAG" >> $GITHUB_OUTPUT
          echo "原仓库最新tag: $LATEST_UPSTREAM_TAG"
          echo "当前fork最新tag: $LATEST_FORK_TAG"

      - name: 判断是否有新tag
        id: check-new-tag
        run: |
          if [ "${{ steps.get-latest-tag.outputs.latest_upstream_tag }}" != "${{ steps.get-latest-tag.outputs.latest_fork_tag }}" ]; then
            echo "has_new_tag=true" >> $GITHUB_OUTPUT
          else
            echo "has_new_tag=false" >> $GITHUB_OUTPUT
          fi

      - name: 获取原仓库Release Notes
        id: get-release-notes
        if: steps.check-new-tag.outputs.has_new_tag == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          UPSTREAM_OWNER: "1Panel-dev"
          UPSTREAM_REPO: "CordysCRM"
          TAG: ${{ steps.get-latest-tag.outputs.latest_upstream_tag }}
        run: |
          NOTES=$(gh api repos/$UPSTREAM_OWNER/$UPSTREAM_REPO/releases/tags/$TAG --jq '.body' 2>/dev/null || echo "无发布说明")
          NOTES_ESCAPED=$(echo "$NOTES" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n//g')
          echo "release_notes=$NOTES_ESCAPED" >> $GITHUB_OUTPUT

      - name: 同步tag并合并到dev-yu
        if: steps.check-new-tag.outputs.has_new_tag == 'true'
        run: |
          git push origin ${{ steps.get-latest-tag.outputs.latest_upstream_tag }}
          if ! git show-ref --verify --quiet refs/heads/dev-yu; then
            git checkout main && git checkout -b dev-yu
          else
            git checkout dev-yu
          fi
          git merge --no-edit --strategy-option theirs ${{ steps.get-latest-tag.outputs.latest_upstream_tag }}
          git push origin dev-yu

      # ====================== 这里是 PushPlus 推送 ======================
      - name: 推送新Tag通知到PushPlus
        if: steps.check-new-tag.outputs.has_new_tag == 'true'
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          TAG: ${{ steps.get-latest-tag.outputs.latest_upstream_tag }}
          RELEASE_NOTES: ${{ steps.get-release-notes.outputs.release_notes }}
        run: |
          curl -X POST https://www.pushplus.plus/send \
            -H "Content-Type: application/json" \
            -d "{
              \"token\":\"$PUSHPLUS_TOKEN\",
              \"title\":\"CordysCRM 发现新Tag\",
              \"content\":\"<b>新版本：</b>$TAG<br><br><b>发布说明：</b><br>$RELEASE_NOTES\",
              \"template\":\"html\"
            }"
