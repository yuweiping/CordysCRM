name: Sync Tag + Build & Push + PushPlus Notify

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      dockerImageTag:
        default: 'latest'
        required: true
        description: 'Dockeré•œåƒæ ‡ç­¾'
      architecture:
        default: 'linux/amd64'
        required: true
        type: choice
        options: [linux/amd64, linux/arm64, linux/amd64,linux/arm64]

permissions:
  contents: write
  packages: write

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    outputs:
      has_new_tag: ${{ steps.check-tag.outputs.has_new_tag }}
      latest_tag: ${{ steps.check-tag.outputs.latest_tag }}
      release_notes: ${{ steps.get-notes.outputs.release_notes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev-yu
          fetch-tags: true

      - name: é…ç½®ä¸Šæ¸¸ä»“åº“ & æ‹‰å–tag
        env:
          UPSTREAM_REPO: "https://github.com/1Panel-dev/CordysCRM.git"
        run: |
          git remote add upstream $UPSTREAM_REPO 2>/dev/null || true
          git fetch upstream --tags --prune

      - name: æ ¸å¿ƒåˆ¤æ–­ï¼šæ˜¯å¦æœ‰æ–°tag
        id: check-tag
        run: |
          # 1. è·å–åŸä»“åº“ï¼ˆupstreamï¼‰è¿œç¨‹æœ€æ–°tagï¼ˆå’Œä¹‹å‰ä¸€è‡´ï¼‰
          UPSTREAM_TAG=$(git ls-remote --tags upstream | grep -v '{}' | awk '{print $2}' | sed 's/refs\/tags\///' | sort -V | tail -n 1 | xargs)
          # 2. å…³é”®ä¿®æ”¹ï¼šè·å–ä½ forkä»“åº“ï¼ˆoriginï¼‰è¿œç¨‹æœ€æ–°tagï¼ˆè€Œérunneræœ¬åœ°ï¼‰
          LOCAL_TAG=$(git ls-remote --tags origin | grep -v '{}' | awk '{print $2}' | sed 's/refs\/tags\///' | sort -V | tail -n 1 | xargs)
          
          # æ‰“å°æ—¥å¿—ï¼Œå¯¹æ¯”è¿œç¨‹vsè¿œç¨‹ï¼ˆå’Œä½ æœ¬åœ°æ‰§è¡Œçš„ç»“æœä¸€è‡´ï¼‰
          echo "ğŸ” åŸä»“åº“(upstream)è¿œç¨‹æœ€æ–°tag: [$UPSTREAM_TAG]"
          echo "ğŸ” ä½ forkä»“åº“(origin)è¿œç¨‹æœ€æ–°tag: [$LOCAL_TAG]"
          
          # ä¸¥æ ¼å¯¹æ¯”
          if [[ -n "$UPSTREAM_TAG" && "$UPSTREAM_TAG" != "$LOCAL_TAG" ]]; then
            echo "âœ… å‘ç°æ–°tag: $UPSTREAM_TAG"
            echo "has_new_tag=true" >> $GITHUB_OUTPUT
            echo "latest_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ— æ–°tagï¼ˆupstream=$UPSTREAM_TAGï¼Œorigin=$LOCAL_TAGï¼‰"
            echo "has_new_tag=false" >> $GITHUB_OUTPUT
            echo "latest_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          fi

      - name: è·å–åŸä»“åº“Release Notesï¼ˆéªŒè¯å‚æ•°ï¼‰
        id: get-notes
        if: steps.check-tag.outputs.has_new_tag == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          UPSTREAM_OWNER: "1Panel-dev"
          UPSTREAM_REPO: "CordysCRM"
          TAG: ${{ steps.check-tag.outputs.latest_tag }}
        run: |
          # æ–°å¢ï¼šæ‰“å°TAGçš„åŸå§‹å€¼å’Œé•¿åº¦ï¼ˆå…³é”®éªŒè¯ï¼‰
          echo "ğŸ” ä¼ é€’è¿‡æ¥çš„TAGåŸå§‹å€¼ï¼š[$TAG]"
          echo "ğŸ” TAGå­—ç¬¦é•¿åº¦ï¼š${#TAG}"
          
          # ä½ ä¹‹å‰çš„æˆåŠŸé€»è¾‘ï¼ˆä»…åŠ ç©ºå€¼å…œåº•ï¼‰
          NOTES=$(gh api repos/$UPSTREAM_OWNER/$UPSTREAM_REPO/releases/tags/$TAG --jq '.body' 2>/dev/null || echo "æ— å‘å¸ƒè¯´æ˜")
          NOTES_ESCAPED=$(echo "$NOTES" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n//g')
          
          # ç©ºå€¼å…œåº•ï¼ˆå”¯ä¸€è¡¥ä¸ï¼‰
          if [ -z "$NOTES_ESCAPED" ]; then
            NOTES_ESCAPED="æ— å‘å¸ƒè¯´æ˜"
          fi
          
          echo "release_notes=$NOTES_ESCAPED" >> $GITHUB_OUTPUT

      - name: åŒæ­¥tag + åˆå¹¶åˆ°dev-yu
        if: steps.check-tag.outputs.has_new_tag == 'true'
        run: |
          git push origin ${{ steps.check-tag.outputs.latest_tag }}
          git checkout dev-yu
          git merge --no-edit --strategy-option theirs ${{ steps.check-tag.outputs.latest_tag }}
          git push origin dev-yu

      - name: PushPlusæ¨é€
        if: steps.check-tag.outputs.has_new_tag == 'true'
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        run: |
          # å®Œå…¨å¤ç”¨ä½ ä¹‹å‰æˆåŠŸçš„å˜é‡è¯»å–æ–¹å¼
          TAG=${{ steps.check-tag.outputs.latest_tag }}
          NOTES=${{ steps.get-notes.outputs.release_notes }}
          
          # æç®€curlå‘½ä»¤ï¼ˆå’Œä½ ä¹‹å‰æˆåŠŸç‰ˆæœ¬ä¸€è‡´ï¼Œæ— emojiã€æ— å¤šä½™æ¢è¡Œï¼‰
          curl -X POST https://www.pushplus.plus/send \
          -H "Content-Type: application/json" \
          -d "{\"token\":\"$PUSHPLUS_TOKEN\",\"title\":\"CordysCRM æ–°Tag: $TAG\",\"content\":\"æ–°ç‰ˆæœ¬ï¼š$TAG<br>å‘å¸ƒè¯´æ˜ï¼š$NOTES\",\"template\":\"html\"}"

  # ========== æ‰“åŒ…æ¨é€ï¼šå’ŒPushPlusä¸¥æ ¼è”åŠ¨ ==========
  build-docker:
    needs: sync-tag
    if: needs.sync-tag.outputs.has_new_tag == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev-yu
          fetch-depth: 0

      - name: å‡†å¤‡é•œåƒæ ‡ç­¾
        id: prepare
        run: |
          TAG=${{ needs.sync-tag.outputs.latest_tag || github.event.inputs.dockerImageTag }}
          echo "build_args=--tag ${{ secrets.DOCKERHUB_USERNAME }}/cordys-crm-ce:$TAG --tag ${{ secrets.DOCKERHUB_USERNAME }}/cordys-crm-ce:latest" >> $GITHUB_OUTPUT

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: ç™»å½•DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: æ„å»ºå¹¶æ¨é€
        run: |
          docker buildx build --platform ${{ github.event.inputs.architecture }} \
            --output "type=image,push=true" \
            ${{ steps.prepare.outputs.build_args }} \
            -f installer/Dockerfile .
