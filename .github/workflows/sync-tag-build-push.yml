name: Sync Tag + Build & Push + PushPlus Notify

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      dockerImageTag:
        default: 'latest'
        required: true
        description: 'Dockeré•œåƒæ ‡ç­¾'
      architecture:
        default: 'linux/amd64'
        required: true
        type: choice
        options: [linux/amd64, linux/arm64, linux/amd64,linux/arm64]

permissions:
  contents: write
  packages: write

jobs:
  sync-tag:
    runs-on: ubuntu-latest
    outputs:
      has_new_tag: ${{ steps.check-tag.outputs.has_new_tag }}
      latest_tag: ${{ steps.check-tag.outputs.latest_tag }}
      release_notes: ${{ steps.get-notes.outputs.release_notes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev-yu
          fetch-tags: true

      - name: é…ç½®ä¸Šæ¸¸ä»“åº“ & æ‹‰å–tag
        env:
          UPSTREAM_REPO: "https://github.com/1Panel-dev/CordysCRM.git"
        run: |
          git remote add upstream $UPSTREAM_REPO 2>/dev/null || true
          git fetch upstream --tags --prune

      - name: æ ¸å¿ƒåˆ¤æ–­ï¼šæ˜¯å¦æœ‰æ–°tag
        id: check-tag
        run: |
          UPSTREAM_TAG=$(git ls-remote --tags upstream | grep -v '{}' | awk '{print $2}' | sed 's/refs\/tags\///' | sort -V | tail -n 1 | xargs)
          LOCAL_TAG=$(git tag -l | sort -V | tail -n 1 | xargs)
      
          # æ–°å¢ä¸¤è¡Œæ—¥å¿—ï¼Œæ‰“å°å®é™…è·å–åˆ°çš„tagå€¼
          echo "ğŸ” åŸä»“åº“æœ€æ–°tag: [$UPSTREAM_TAG]"
          echo "ğŸ” æœ¬åœ°forkæœ€æ–°tag: [$LOCAL_TAG]"
      
          if [[ -n "$UPSTREAM_TAG" && "$UPSTREAM_TAG" != "$LOCAL_TAG" ]]; then
            echo "âœ… å‘ç°æ–°tag: $UPSTREAM_TAG"
            echo "has_new_tag=true" >> $GITHUB_OUTPUT
            echo "latest_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ— æ–°tagï¼ˆåŸtag=$UPSTREAM_TAGï¼Œæœ¬åœ°tag=$LOCAL_TAGï¼‰"
            echo "has_new_tag=false" >> $GITHUB_OUTPUT
            echo "latest_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
          fi

      - name: è·å–Releaseè¯´æ˜ï¼ˆè½»é‡å…œåº•ï¼‰
        id: get-notes
        if: steps.check-tag.outputs.has_new_tag == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=${{ steps.check-tag.outputs.latest_tag }}
          # ä¿®å¤1ï¼šjq åŠ å®¹é”™ï¼Œé¿å…è§£æå¤±è´¥è¿”å›ç©º
          # ä¿®å¤2ï¼šä»…å½“æœ€ç»ˆç»“æœä¸ºç©ºæ—¶å…œåº•ï¼Œä¸å½±å“æ­£å¸¸å†…å®¹
          NOTES=$(gh api repos/1Panel-dev/CordysCRM/releases/tags/$TAG --jq '.body // "æ— å‘å¸ƒè¯´æ˜"' 2>/dev/null || echo "æ— å‘å¸ƒè¯´æ˜")
          # ä»…è½¬ä¹‰æ¢è¡Œï¼Œä¸ä¿®æ”¹åŸæœ‰å†…å®¹
          NOTES=$(echo "$NOTES" | sed 's/\n/<br>/g')
          echo "release_notes=$NOTES" >> $GITHUB_OUTPUT

      - name: åŒæ­¥tag + åˆå¹¶åˆ°dev-yu
        if: steps.check-tag.outputs.has_new_tag == 'true'
        run: |
          git push origin ${{ steps.check-tag.outputs.latest_tag }}
          git checkout dev-yu
          git merge --no-edit --strategy-option theirs ${{ steps.check-tag.outputs.latest_tag }}
          git push origin dev-yu

      - name: PushPlusæ¨é€
        if: steps.check-tag.outputs.has_new_tag == 'true'
        env:
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        run: |
          TAG=${{ steps.check-tag.outputs.latest_tag }}
          NOTES=${{ steps.get-notes.outputs.release_notes }}
          curl -X POST https://www.pushplus.plus/send \
            -H "Content-Type: application/json" \
            -d "{
              \"token\":\"$PUSHPLUS_TOKEN\",
              \"title\":\"CordysCRM æ–°Tag: $TAG\",
              \"content\":\"æ–°ç‰ˆæœ¬ï¼š$TAG<br>å‘å¸ƒè¯´æ˜ï¼š$NOTES\",
              \"template\":\"html\"
            }"

  # ========== æ‰“åŒ…æ¨é€ï¼šå’ŒPushPlusä¸¥æ ¼è”åŠ¨ ==========
  build-docker:
    needs: sync-tag
    if: needs.sync-tag.outputs.has_new_tag == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev-yu
          fetch-depth: 0

      - name: å‡†å¤‡é•œåƒæ ‡ç­¾
        id: prepare
        run: |
          TAG=${{ needs.sync-tag.outputs.latest_tag || github.event.inputs.dockerImageTag }}
          echo "build_args=--tag ${{ secrets.DOCKERHUB_USERNAME }}/cordys-crm-ce:$TAG --tag ${{ secrets.DOCKERHUB_USERNAME }}/cordys-crm-ce:latest" >> $GITHUB_OUTPUT

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: ç™»å½•DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: æ„å»ºå¹¶æ¨é€
        run: |
          docker buildx build --platform ${{ github.event.inputs.architecture }} \
            --output "type=image,push=true" \
            ${{ steps.prepare.outputs.build_args }} \
            -f installer/Dockerfile .
